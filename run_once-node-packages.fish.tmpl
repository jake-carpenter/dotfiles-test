#!/usr/bin/env fish

# Hash the packages file to trigger a change here when there's a change there.
# packages.yaml hash: {{ include ".chezmoidata/packages.yaml" | sha256sum }}

# Base profile
{{ range .packages.npm.base }}
  set -a packages {{ . | quote }}
{{ end }}

# Desktop profile
{{ if has .chezmoi.hostname .systems.desktop }}
  {{ range .packages.npm.desktop }}
    set -a packages {{ . | quote }}
  {{ end -}}
{{ end }}

# Personal profile
{{ if has .chezmoi.hostname .systems.personal }}
  {{ range .packages.npm.personal }}
    set -a packages {{ . | quote }}
  {{ end -}}
{{ end }}

echo -e "\nğŸš€ Checking for missing NPM packages\n"

set missing_packages

for package in $packages
  if not npm list $package -g --parseable 2>/dev/null | grep -q $package
    echo "âŒ $package"
    set -a missing_packages $package
  else
    echo "âœ… $package"
  end
end

if test (count $missing_packages) -gt 0
  echo -e "\nğŸš€ Installing missing packages\n"
  npm -g install $missing_packages
  echo -e "\nğŸ‰ All missing packages have been installed.\n"
else
  echo -e "\nğŸ‘ All packages are already installed.\n"
end
